# 团队拾取计数器 - 更新日志

## 版本 1.2.6 (2026-02-11)

### ✨ 新增功能
#### 1. 手动添加装备 (Manual Add)
- **功能入口**：在“历史掉落记录”窗口右上角新增了“手动添加”按钮。
- **背包扫描**：点击后会打开一个新窗口，自动扫描玩家背包中所有的史诗 (Epic) 及以上品质的装备。
- **智能识别**：支持识别 T7/T8/T9/T10 套装部件，并在列表中标记 `[T9]` 等前缀。
- **属性标记**：自动检测装备绑定 (BOE) 属性，并在列表中标记 `[BOE]`。
- **记录补录**：选中装备并点击“保存”后，该装备将以“手动添加”的 Boss 名义加入历史记录，方便补录漏掉的掉落或交易获得的装备。

#### 2. Roll 点捕获优化
- **状态保护**：当 Roll 点捕获正在进行时，点击“开启 roll 捕获”不再会打开装备分配窗口，而是提示用户先停止当前的捕获，防止误操作。

### 🎨 UI 与交互优化
- **窗口位置管理**：
  - 每次打开“历史掉落记录”或“手动添加装备”窗口时，窗口现在会自动重置到屏幕中央，防止因意外拖动导致窗口丢失。
- **布局一致性**：
  - “手动添加装备”窗口的布局（列表样式、行高、高亮效果）现在与“分配装备”窗口完全保持一致。
- **多语言支持**：
  - 完善了繁体中文 (zhTW) 的本地化翻译，补全了手动添加功能相关的文本。
  - 优化了简体中文下 T9 套装的识别逻辑，兼容更多种类的文本格式（如“萨尔的征服头饰”）。

---

## 版本 1.2.0 (2026-02-10)

### ✨ 新增功能
#### 1. 窗口管理系统
- **最小化模式**：主窗口右上角新增 `-` 按钮。点击后，主窗口将隐藏，并在屏幕右上方显示一个名为 "RLC-PIN" 的小型悬浮条。
- **快速恢复**：点击 "RLC-PIN" 悬浮条上的 `+` 按钮，即可恢复主窗口并将其重置到屏幕中央。
- **位置重置命令**：新增 `/rlc reset` 命令。如果窗口被拖到屏幕外找不到了，输入此命令可强制将所有插件窗口（主窗口、分配窗口、历史窗口）重置到屏幕正中央。

#### 2. 装备分配优化
- **智能排序**：在“分配装备”列表中，标记为 **MS** (Main-Spec) 的装备现在会自动置顶，方便快速查找和分配。
- **交互改进**：点击分配窗口（`+`）时，窗口位置现在会自动居中，避免上次关闭时的位置导致窗口不可见。

### 🐛 问题修复与改进
- **空指针保护**：修复了在极少数情况下，点击玩家列表的 `+` 号时因无法获取玩家名称而导致的 Lua 报错。现在若发生此类错误，聊天框会输出明确的红色错误提示。
- **Mock 数据注入**：优化了 `/rlc debug` 命令，现在可以更稳定地生成测试用的 Boss 和掉落数据，用于演示和测试历史记录功能。
- **UI 健壮性**：增强了 `OnPlusClick` 和 `OnMinusClick` 的错误处理逻辑，确保在 UI 元素未完全加载时不会导致插件崩溃。

---

## 版本 1.1.0 (2026-02-01)

### ✨ Roll点捕获功能
**新增内容**：
- 在UI界面添加"开启roll捕获"和"停止roll捕获"按钮
- 支持监听团队roll点聊天消息
- 自动解析roll点结果并更新对应成员的拾取计数
- 提供用户友好的状态提示

**实现细节**：
- 新增两个按钮控件，位于"更新数量后立刻团队通知"复选框右侧
- 添加本地化支持（英文、简体中文、繁体中文）
- 实现聊天消息监听，自动解析roll点格式："Player rolls 85 (1-100)"
- 只记录团队成员的roll点结果，按点数降序显示排名
- 前三名使用金银铜颜色标识，突出显示获胜者
- 修复服务器名处理问题：正确匹配跨服团队成员名称
- 优化事件监听器管理，防止内存泄漏
- 提供完整的状态提示和错误处理
- 添加调试信息，帮助诊断捕获问题

### 🎨 UI布局优化
**调整内容**：
- 将"更新数量后立刻团队通知"复选框移至界面最右侧
- 重新排列按钮顺序：同步团队 → 清空数据 → 发送统计 → 开启roll捕获 → 停止roll捕获 → 自动通知复选框
- 优化界面视觉层次和操作流程

---

## 版本 1.0.1 (2026-02-01)

### 🐛 Bug修复

#### 1. 修复点击"+"按钮导致列表消失的问题
**问题原因**：
- 按钮点击事件中使用了闭包变量 `player.name`
- 在 RefreshDisplay 后，闭包变量可能指向已清除的临时对象

**解决方案**：
- 在创建按钮前，将 `player.name` 保存到局部变量 `currentPlayerName`
- 按钮点击事件使用局部变量而非闭包变量
- 增加数据存在性检查 `if RaidLootCounterDB[currentPlayerName]`
- 在调用 RefreshDisplay 前先获取新的计数值

#### 2. 修复清空数据后职业标题残留的问题
**问题原因**：
- 职业标题是 FontString 对象，不是 Frame
- 原清除逻辑只清除了 Frame 子元素，没有清除 FontString

**解决方案**：
- 增加对所有 Region 的遍历
- 专门清除 FontString 类型的对象
- 数据为空时，直接返回不创建任何UI元素

#### 3. 优化同步团队功能
**改进内容**：
- 同步时保留已有成员的拾取记录
- 只有新成员才初始化为 0
- 显示新增成员数量提示
- 增加不在团队时的错误提示

#### 4. 优化发送格式
**更新内容**：
- 单次更新格式：`{人名} - {Add/Remove} {数量} - {更新后总数}`
- 示例：`张三 - Add 1 - 5`
